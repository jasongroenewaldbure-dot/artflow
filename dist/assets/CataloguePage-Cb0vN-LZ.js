import{n as c,s as z,e as L,u as A,r as d,j as e,a as x,H as P,z as g}from"./index-Tyz_JBt9.js";import{h as I}from"./errorHandling-CFCT0cl6.js";import{L as R}from"./lock-BkYk8nJ6.js";import{U as D}from"./user-B7duxeUb.js";import{E as T}from"./eye-Ctq-Wxgo.js";import{C as $}from"./calendar-DCCf2P0w.js";import{G as N}from"./globe-n10bFvIm.js";import{H}from"./heart-BZ8u-Y3T.js";import{S as W}from"./share-2-BUMbV-vM.js";import"./logger-CnymG8OQ.js";import"./createLucideIcon-DhCu6Z8O.js";class h{static instance;retryQueue=new Map;activeRetries=new Map;constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async executeWithRetry(r,t,a={}){const s={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:this.defaultRetryCondition,...a};if(this.activeRetries.has(t))return this.activeRetries.get(t);const n=this.performRetry(r,t,s);this.activeRetries.set(t,n);try{return await n}finally{this.activeRetries.delete(t)}}async performRetry(r,t,a){let s,n=0;for(;n<=a.maxRetries;)try{const o=await r();return this.retryQueue.delete(t),n>0&&c.success(`Operation succeeded after ${n} retries`),o}catch(o){s=o,n++;const u=this.analyzeError(o);if(!u.isRetryable||n>a.maxRetries||!a.retryCondition(u))throw o;const y=this.calculateDelay(n,a,u.retryAfter);console.warn(`Operation ${t} failed (attempt ${n}/${a.maxRetries+1}), retrying in ${y}ms`,o),n===1&&c.loading("Connection lost. Retrying...",{id:t}),await this.delay(y)}throw c.error(`Operation failed after ${a.maxRetries+1} attempts`,{id:t}),s}analyzeError(r){if(r.code==="NETWORK_ERROR"||r.message?.includes("Network Error"))return{code:"NETWORK_ERROR",message:"Network connection failed",isRetryable:!0};if(r.status)switch(r.status){case 408:case 429:case 500:case 502:case 503:case 504:return{code:"HTTP_ERROR",message:r.message||"Server error",status:r.status,isRetryable:!0,retryAfter:this.extractRetryAfter(r)};case 401:case 403:case 404:return{code:"CLIENT_ERROR",message:r.message||"Client error",status:r.status,isRetryable:!1};default:return{code:"UNKNOWN_ERROR",message:r.message||"Unknown error",status:r.status,isRetryable:r.status>=500}}if(r.code)switch(r.code){case"PGRST301":case"PGRST302":return{code:"SUPABASE_CONNECTION_ERROR",message:"Database connection failed",isRetryable:!0};case"PGRST116":return{code:"AUTH_ERROR",message:"Authentication expired",isRetryable:!1};default:return{code:"SUPABASE_ERROR",message:r.message||"Database error",isRetryable:r.code.startsWith("PGRST3")}}return{code:"UNKNOWN_ERROR",message:r.message||"Unknown error",isRetryable:!1}}defaultRetryCondition(r){return r.isRetryable}calculateDelay(r,t,a){if(a)return Math.min(a*1e3,t.maxDelay);const s=t.baseDelay*Math.pow(t.backoffMultiplier,r-1),n=Math.random()*.1*s;return Math.min(s+n,t.maxDelay)}extractRetryAfter(r){const t=r.headers?.["retry-after"]||r.headers?.["Retry-After"];return t?parseInt(t,10):void 0}delay(r){return new Promise(t=>setTimeout(t,r))}queueForRetry(r,t,a={}){const s={maxRetries:5,baseDelay:2e3,maxDelay:3e4,backoffMultiplier:1.5,retryCondition:this.defaultRetryCondition,...a};this.retryQueue.set(t,s),this.executeWithRetry(r,t,s).catch(()=>{console.log(`Operation ${t} queued for retry`)})}async checkNetworkStatus(){try{return(await fetch("/api/health",{method:"HEAD",cache:"no-cache",signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async retryQueuedOperations(){const r=Array.from(this.retryQueue.entries());if(r.length===0)return;console.log(`Retrying ${r.length} queued operations`),c.loading(`Retrying ${r.length} operations...`);const t=await Promise.allSettled(r.map(([n,o])=>this.executeWithRetry(()=>Promise.resolve(),n,o))),a=t.filter(n=>n.status==="fulfilled").length,s=t.filter(n=>n.status==="rejected").length;a>0&&c.success(`${a} operations completed successfully`),s>0&&c.error(`${s} operations failed`)}clearRetryQueue(){this.retryQueue.clear(),this.activeRetries.clear()}getRetryStats(){return{queued:this.retryQueue.size,active:this.activeRetries.size}}}const j=h.getInstance();class f{static instance;isOnline=navigator.onLine;listeners=new Set;checkInterval;constructor(){this.setupEventListeners(),this.startPeriodicCheck()}static getInstance(){return f.instance||(f.instance=new f),f.instance}setupEventListeners(){window.addEventListener("online",()=>{this.handleOnline()}),window.addEventListener("offline",()=>{this.handleOffline()})}startPeriodicCheck(){this.checkInterval=setInterval(async()=>{const r=await j.checkNetworkStatus();r!==this.isOnline&&(this.isOnline=r,this.notifyListeners())},3e4)}handleOnline(){this.isOnline=!0,this.notifyListeners(),j.retryQueuedOperations(),c.success("Connection restored")}handleOffline(){this.isOnline=!1,this.notifyListeners(),c.error("Connection lost")}notifyListeners(){this.listeners.forEach(r=>r(this.isOnline))}addListener(r){return this.listeners.add(r),()=>this.listeners.delete(r)}getStatus(){return this.isOnline}destroy(){this.checkInterval&&clearInterval(this.checkInterval),this.listeners.clear()}}f.getInstance();const U=async(m,r)=>{try{const{data:t,error:a}=await z.from("catalogues").select(`
        *,
        profiles!catalogues_user_id_fkey (
          id,
          display_name,
          slug,
          avatar_url
        )
      `).eq("slug",r).eq("profiles.slug",m).single();if(a)throw a;return t?{id:t.id,title:t.title,description:t.description,cover_image_url:t.cover_image_url,created_at:t.created_at,updated_at:t.updated_at,artist:t.profiles?Array.isArray(t.profiles)?{id:t.profiles[0]?.id||"",name:t.profiles[0]?.display_name||t.profiles[0]?.name||"Unknown Artist",slug:t.profiles[0]?.slug||"",full_name:t.profiles[0]?.full_name,avatar_url:t.profiles[0]?.avatar_url,is_verified:t.profiles[0]?.is_verified||!1}:{id:t.profiles.id||"",name:t.profiles.display_name||t.profiles.name||"Unknown Artist",slug:t.profiles.slug||"",full_name:t.profiles.full_name,avatar_url:t.profiles.avatar_url,is_verified:t.profiles.is_verified||!1}:void 0}:null}catch(t){return I(t,{component:"fetchCatalogue",action:"fetch"}),null}},Z=()=>{const{artistSlug:m,catalogueSlug:r,id:t}=L(),a=A(),[s,n]=d.useState(null),[o,u]=d.useState(!0),[y,v]=d.useState(null),[b,k]=d.useState(""),[C,w]=d.useState(!1),[p,S]=d.useState(!1);d.useEffect(()=>{(async()=>{try{u(!0),v(null);let l;if(m&&r)l=await U(m,r);else{if(t)throw new Error("Fallback URL not implemented yet");a("/",{replace:!0});return}n(l),l.access_mode==="password"&&!l.is_public&&w(!0)}catch(l){console.error("Error loading catalogue:",l),v(l.message||"Failed to load catalogue")}finally{u(!1)}})()},[m,r,t,a]);const _=i=>{i.preventDefault(),s&&b===s.password?(w(!1),g.success("Access granted!")):g.error("Incorrect password")},E=async()=>{if(s)try{S(!p),g.success(p?"Removed from favorites":"Added to favorites")}catch{g.error("Failed to update favorites")}},O=async()=>{if(s)try{const i=window.location.href;navigator.share?await navigator.share({title:s.title,text:s.description||"",url:i}):(await navigator.clipboard.writeText(i),g.success("Link copied to clipboard!"))}catch{g.error("Failed to share catalogue")}};return o?e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",flexDirection:"column",gap:"var(--space-lg)"},children:[e.jsx("div",{style:{width:"40px",height:"40px",border:"3px solid var(--border)",borderTop:"3px solid var(--primary)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("p",{style:{color:"var(--muted)",fontSize:"16px"},children:"Loading catalogue..."})]}):y||!s?e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",flexDirection:"column",gap:"var(--space-lg)"},children:[e.jsx("h1",{style:{fontSize:"24px",color:"var(--fg)"},children:"Catalogue Not Found"}),e.jsx("p",{style:{color:"var(--muted)"},children:y||"The catalogue you're looking for doesn't exist."}),e.jsx(x,{to:"/",className:"brush-button primary",children:"Return Home"})]}):C?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",padding:"var(--space-xl)"},children:e.jsxs("div",{style:{backgroundColor:"var(--card)",borderRadius:"var(--radius-lg)",padding:"var(--space-2xl)",maxWidth:"400px",width:"100%",textAlign:"center"},children:[e.jsx(R,{size:48,style:{color:"var(--primary)",margin:"0 auto var(--space-lg)"}}),e.jsx("h2",{style:{fontSize:"24px",marginBottom:"var(--space-md)",color:"var(--fg)"},children:"Password Required"}),e.jsx("p",{style:{color:"var(--muted)",marginBottom:"var(--space-xl)"},children:"This catalogue is password protected. Please enter the password to view it."}),e.jsxs("form",{onSubmit:_,style:{display:"flex",flexDirection:"column",gap:"var(--space-md)"},children:[e.jsx("input",{type:"password",placeholder:"Enter password",value:b,onChange:i=>k(i.target.value),required:!0,style:{padding:"var(--space-md)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",backgroundColor:"var(--bg-alt)",color:"var(--fg)",fontSize:"16px",outline:"none"}}),e.jsx("button",{type:"submit",className:"brush-button primary",children:"Access Catalogue"})]})]})}):e.jsxs("div",{style:{minHeight:"100vh",backgroundColor:"var(--bg)"},children:[e.jsxs(P,{children:[e.jsxs("title",{children:[s.title," | ",s.artist.full_name," | ArtFlow"]}),e.jsx("meta",{name:"description",content:s.description||`Catalogue by ${s.artist.full_name}`}),e.jsx("meta",{property:"og:title",content:s.title}),e.jsx("meta",{property:"og:description",content:s.description||`Catalogue by ${s.artist.full_name}`}),e.jsx("meta",{property:"og:image",content:s.cover_image_url||""}),e.jsx("meta",{property:"og:type",content:"website"})]}),e.jsx("div",{style:{backgroundColor:"var(--card)",borderBottom:"1px solid var(--border)",padding:"var(--space-xl) 0"},children:e.jsxs("div",{style:{maxWidth:"1200px",margin:"0 auto",padding:"0 var(--space-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-lg)",marginBottom:"var(--space-lg)"},children:[e.jsxs(x,{to:`/artist/${s.artist.slug}`,style:{display:"flex",alignItems:"center",gap:"var(--space-sm)",textDecoration:"none",color:"var(--muted)",fontSize:"14px"},children:[e.jsx(D,{size:16}),s.artist.full_name]}),e.jsx("span",{style:{color:"var(--border)",fontSize:"14px"},children:"/"}),e.jsx("span",{style:{color:"var(--fg)",fontSize:"14px"},children:"Catalogue"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("h1",{style:{fontSize:"32px",fontWeight:"700",color:"var(--fg)",margin:"0 0 var(--space-md) 0",lineHeight:"1.2"},children:s.title}),s.description&&e.jsx("p",{style:{fontSize:"16px",color:"var(--muted)",margin:"0 0 var(--space-lg) 0",lineHeight:"1.6"},children:s.description}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-lg)",marginBottom:"var(--space-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-xs)"},children:[e.jsx(T,{size:16,style:{color:"var(--muted)"}}),e.jsxs("span",{style:{fontSize:"14px",color:"var(--muted)"},children:[s.items.length," artwork",s.items.length!==1?"s":""]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-xs)"},children:[e.jsx($,{size:16,style:{color:"var(--muted)"}}),e.jsx("span",{style:{fontSize:"14px",color:"var(--muted)"},children:new Date(s.created_at).toLocaleDateString()})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-xs)"},children:[s.access_mode==="public"?e.jsx(N,{size:16,style:{color:"var(--success)"}}):e.jsx(R,{size:16,style:{color:"var(--warning)"}}),e.jsx("span",{style:{fontSize:"14px",color:"var(--muted)"},children:s.access_mode==="public"?"Public":"Private"})]})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-sm)"},children:[e.jsxs("button",{onClick:E,style:{display:"flex",alignItems:"center",gap:"var(--space-xs)",padding:"var(--space-sm) var(--space-md)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",backgroundColor:p?"var(--primary)":"var(--card)",color:p?"white":"var(--fg)",cursor:"pointer",transition:"all 0.2s ease"},children:[e.jsx(H,{size:16,fill:p?"currentColor":"none"}),p?"Liked":"Like"]}),e.jsxs("button",{onClick:O,style:{display:"flex",alignItems:"center",gap:"var(--space-xs)",padding:"var(--space-sm) var(--space-md)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",backgroundColor:"var(--card)",color:"var(--fg)",cursor:"pointer",transition:"all 0.2s ease"},children:[e.jsx(W,{size:16}),"Share"]})]})]})]})}),e.jsx("div",{style:{maxWidth:"1200px",margin:"0 auto",padding:"var(--space-2xl) var(--space-lg)"},children:s.items.length>0?e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"var(--space-xl)"},children:s.items.sort((i,l)=>i.position-l.position).map(i=>e.jsx(x,{to:`/artist/${s.artist.slug}/${i.artwork.slug}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{backgroundColor:"var(--card)",borderRadius:"var(--radius-lg)",overflow:"hidden",transition:"transform 0.2s ease, box-shadow 0.2s ease",cursor:"pointer"},onMouseEnter:l=>{l.currentTarget.style.transform="translateY(-4px)",l.currentTarget.style.boxShadow="var(--shadow-lg)"},onMouseLeave:l=>{l.currentTarget.style.transform="translateY(0)",l.currentTarget.style.boxShadow="none"},children:[i.artwork.primary_image_url?e.jsx("div",{style:{width:"100%",height:"300px",backgroundImage:`url(${i.artwork.primary_image_url})`,backgroundSize:"cover",backgroundPosition:"center",backgroundColor:"var(--bg-alt)"}}):e.jsx("div",{style:{width:"100%",height:"300px",backgroundColor:"var(--bg-alt)",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted)"},children:"No Image"}),e.jsxs("div",{style:{padding:"var(--space-lg)"},children:[e.jsx("h3",{style:{fontSize:"18px",fontWeight:"600",color:"var(--fg)",margin:"0 0 var(--space-sm) 0",lineHeight:"1.3"},children:i.artwork.title||"Untitled"}),i.artwork.price&&e.jsxs("p",{style:{fontSize:"16px",fontWeight:"500",color:"var(--primary)",margin:"0 0 var(--space-sm) 0"},children:["$",i.artwork.price.toLocaleString()]}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"var(--space-xs)",fontSize:"14px",color:"var(--muted)"},children:e.jsx("span",{style:{padding:"2px 8px",backgroundColor:i.artwork.status==="available"?"var(--success-bg)":"var(--warning-bg)",color:i.artwork.status==="available"?"var(--success)":"var(--warning)",borderRadius:"var(--radius-sm)",fontSize:"12px",fontWeight:"500"},children:i.artwork.status==="available"?"Available":"Sold"})})]})]})},i.id))}):e.jsxs("div",{style:{textAlign:"center",padding:"var(--space-3xl) 0",color:"var(--muted)"},children:[e.jsx("h3",{style:{fontSize:"20px",marginBottom:"var(--space-md)"},children:"No artworks in this catalogue yet"}),e.jsx("p",{children:"Check back later for new additions."})]})})]})};export{Z as default};
