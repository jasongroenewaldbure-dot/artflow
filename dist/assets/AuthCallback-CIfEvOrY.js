import{s as d,u as S,c as A,r as b,j as o,z as g}from"./index-Tyz_JBt9.js";import{s as y}from"./errorHandling-CFCT0cl6.js";import{L as E}from"./loader-BX6vvf7J.js";import{C as x}from"./circle-alert-Csbyw32W.js";import{C as U}from"./circle-check-big-D0cnAB6B.js";import"./logger-CnymG8OQ.js";import"./createLucideIcon-DhCu6Z8O.js";class N{async hasProfile(e){try{const{data:r,error:a}=await d.from("profiles").select("id").eq("id",e).single();if(a&&a.code!=="PGRST116")throw a;return!!r}catch(r){return console.error("Error checking profile existence:",r),!1}}async getProfile(e){try{const{data:r,error:a}=await d.from("profiles").select("*").eq("id",e).single();if(a){if(a.code==="PGRST116")return null;throw a}return r}catch(r){return console.error("Error fetching profile:",r),null}}async createProfile(e){try{const r={id:e.id,full_name:e.user_metadata?.full_name||"User",display_name:e.user_metadata?.display_name||e.user_metadata?.full_name||"User",slug:e.user_metadata?.slug||e.id,role:(e.app_metadata?.role||"COLLECTOR").toUpperCase(),created_at:e.created_at,updated_at:e.updated_at||new Date().toISOString(),avatar_url:e.user_metadata?.avatar_url,bio:e.user_metadata?.bio,location:e.user_metadata?.location,website:e.user_metadata?.website},{data:a,error:c}=await d.from("profiles").insert([r]).select().single();if(c)throw c;return console.log("Profile created successfully:",a),a}catch(r){return console.error("Error creating profile:",r),y("Failed to create user profile"),null}}async updateProfile(e,r){try{const a={updated_at:new Date().toISOString()};r.user_metadata?.full_name&&(a.full_name=r.user_metadata.full_name),r.user_metadata?.display_name&&(a.display_name=r.user_metadata.display_name),r.user_metadata?.slug&&(a.slug=r.user_metadata.slug),r.app_metadata?.role&&(a.role=r.app_metadata.role.toUpperCase()),r.user_metadata?.avatar_url&&(a.avatar_url=r.user_metadata.avatar_url),r.user_metadata?.bio&&(a.bio=r.user_metadata.bio),r.user_metadata?.location&&(a.location=r.user_metadata.location),r.user_metadata?.website&&(a.website=r.user_metadata.website);const{data:c,error:m}=await d.from("profiles").update(a).eq("id",e).select().single();if(m)throw m;return console.log("Profile updated successfully:",c),c}catch(a){return console.error("Error updating profile:",a),y("Failed to update user profile"),null}}async syncUserProfile(e){try{return e.id?await this.hasProfile(e.id)?(console.log("Updating existing profile for user:",e.id),await this.updateProfile(e.id,e)):(console.log("Creating new profile for user:",e.id),await this.createProfile(e)):(console.error("User ID is required for profile sync"),null)}catch(r){return console.error("Error syncing user profile:",r),null}}async validateProfile(e){const r=[],a=[];return(!e.name||e.name.trim()==="")&&(r.push("name"),a.push("Please add your full name")),(!e.slug||e.slug.trim()==="")&&(r.push("slug"),a.push("Please add a unique slug for your profile")),{isValid:r.length===0,missingFields:r,suggestions:a}}async getUsersWithoutProfiles(){try{return console.warn("getUsersWithoutProfiles requires admin access - implement server-side"),[]}catch(e){return console.error("Error fetching users without profiles:",e),[]}}async bulkSyncProfiles(){try{return console.warn("bulkSyncProfiles requires admin access - implement server-side"),{success:0,failed:0,errors:["Admin access required"]}}catch(e){return console.error("Error in bulk sync:",e),{success:0,failed:1,errors:[e instanceof Error?e.message:"Unknown error"]}}}}const P=new N;function G(){const n=S(),[e]=A(),[r,a]=b.useState("loading"),[c,m]=b.useState("");return b.useEffect(()=>{let k=!1;(async()=>{if(!k){k=!0;try{a("loading"),console.log("AuthCallback: Starting auth callback handling");const l=new URLSearchParams(window.location.hash.substring(1)),i=l.get("access_token"),_=l.get("refresh_token"),f=l.get("error"),h=l.get("error_description");if(console.log("AuthCallback: URL params:",{hasAccessToken:!!i,hasRefreshToken:!!_,error:f,errorDescription:h}),f)throw console.error("AuthCallback: Error in URL params:",f,h),f==="access_denied"?new Error("Access was denied. Please try again."):f==="server_error"?new Error("Server error occurred. Please try again later."):h?.includes("expired")?new Error("The verification link has expired. Please request a new one."):h?.includes("invalid")?new Error("The verification link is invalid. Please request a new one."):new Error(h||f);if(i&&_){console.log("AuthCallback: Setting session with tokens");const{error:u}=await d.auth.setSession({access_token:i,refresh_token:_});if(u)throw console.error("AuthCallback: Session error:",u),u}console.log("AuthCallback: Getting current user");const{data:{user:s},error:w}=await d.auth.getUser();if(w)throw console.error("AuthCallback: User error:",w),w;if(!s)throw console.error("AuthCallback: No user found"),new Error("No user found after authentication");console.log("AuthCallback: Found user:",s.id,s.email);const v=e.get("role")||sessionStorage.getItem("selectedRole");sessionStorage.getItem("selectedRole")&&sessionStorage.removeItem("selectedRole"),console.log("AuthCallback: Checking profile for user:",s.id);const{data:t,error:p}=await d.from("profiles").select("id, role, display_name, full_name, created_at").eq("id",s.id).single();if(p&&p.code!=="PGRST116")throw console.error("AuthCallback: Profile error:",p),p;if(console.log("AuthCallback: Profile found:",!!t),!t){console.log("AuthCallback: Creating new profile");const u={...s,app_metadata:{...s.app_metadata,role:v||"collector"}};if(!await P.syncUserProfile(u))throw console.error("AuthCallback: Failed to create profile"),new Error("Failed to create user profile");console.log("AuthCallback: Profile created successfully"),a("success"),g.success("Welcome! Let's set up your profile."),n("/onboarding",{replace:!0});return}if(t){console.log("AuthCallback: Syncing existing profile");const u={id:s.id,email:s.email||"",user_metadata:{full_name:s.user_metadata?.full_name||t.display_name||t.full_name,avatar_url:s.user_metadata?.avatar_url||t.avatar_url,bio:s.user_metadata?.bio||t.bio,location:s.user_metadata?.location||t.location,website:s.user_metadata?.website||t.website},app_metadata:{role:t.role},created_at:s.created_at,updated_at:s.updated_at||new Date().toISOString()};await P.syncUserProfile(u)}const C=s.user_metadata?.password_set||t?.password_set||!1;if(!t?.profile_completed||!t?.onboarding_completed||!C){console.log("AuthCallback: User needs onboarding"),a("success"),g.success("Please complete your profile setup."),n("/onboarding",{replace:!0});return}console.log("AuthCallback: User is fully set up, redirecting to dashboard"),a("success"),g.success("Successfully signed in!"),n("/u/dashboard",{replace:!0})}catch(l){console.error("Auth callback error:",l);let i="An error occurred during authentication. Please try again.";l.message?.includes("Email link is invalid or has expired")?i="The verification link has expired. Please request a new one.":l.message?.includes("Invalid login credentials")?i="Invalid credentials. Please check your email and password.":l.message?.includes("Email not confirmed")?i="Please check your email and click the verification link.":l.message?.includes("expired")?i="The verification link has expired. Please request a new one.":l.message?.includes("invalid")&&(i="The verification link is invalid. Please request a new one."),m(i),a("error"),g.error(i),setTimeout(()=>{n("/start",{replace:!0})},3e3)}}})()},[n,e,r]),r==="loading"?o.jsxs("div",{className:"auth-callback-container",children:[o.jsx(E,{size:40,className:"auth-callback-icon"}),o.jsx("h2",{className:"auth-callback-title",children:"Signing you in..."}),o.jsx("p",{className:"auth-callback-message",children:"Please wait while we complete your authentication."})]}):r==="error"?o.jsxs("div",{className:"auth-callback-container",children:[o.jsx(x,{size:40,className:"auth-callback-icon error"}),o.jsx("h2",{className:"auth-callback-title error",children:"Authentication Failed"}),o.jsx("p",{className:"auth-callback-message",children:c}),o.jsx("button",{onClick:()=>n("/start"),className:"btn btn-primary",children:"Try Again"})]}):o.jsxs("div",{className:"auth-callback-container",children:[o.jsx(U,{size:40,className:"auth-callback-icon success"}),o.jsx("h2",{className:"auth-callback-title success",children:"Success!"}),o.jsx("p",{className:"auth-callback-message",children:"Redirecting you now..."})]})}export{G as default};
