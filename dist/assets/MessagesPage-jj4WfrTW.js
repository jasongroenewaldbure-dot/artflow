import{d as E,r as i,s as m,j as e,H as q,a as A}from"./index-Tyz_JBt9.js";import{C as M}from"./Container-D0TcWsx1.js";import{s as x,a as T}from"./errorHandling-CFCT0cl6.js";import{I as c}from"./Icon-DdnnFTJv.js";import"./logger-CnymG8OQ.js";const D=()=>{const{user:l}=E(),[g,w]=i.useState([]),[t,_]=i.useState(null),[N,v]=i.useState([]),[n,u]=i.useState(""),[k,h]=i.useState(!0),[o,p]=i.useState(!1);i.useEffect(()=>{l&&y()},[l]),i.useEffect(()=>{t&&b(t.id)},[t]);const y=async()=>{try{h(!0);const{data:s,error:a}=await m.from("conversations").select(`
          id, status, last_message_at, last_message_preview, artist_unread, inquirer_unread, created_at,
          artworks!inner(
            id, title, primary_image_url, price, currency
          ),
          profiles!conversations_artist_id_fkey(
            id, display_name, avatar_url
          )
        `).eq("inquirer_user_id",l?.id).order("last_message_at",{ascending:!1});if(a)throw a;const d=(s||[]).map(r=>({id:r.id,artwork:{id:r.artworks.id,title:r.artworks.title||"Untitled",primary_image_url:r.artworks.primary_image_url||"",price:r.artworks.price||0,currency:r.artworks.currency||"ZAR"},artist:{id:r.profiles.id,display_name:r.profiles.display_name||"Unknown Artist",avatar_url:r.profiles.avatar_url},status:r.status,last_message_at:r.last_message_at,last_message_preview:r.last_message_preview||"",artist_unread:r.artist_unread,inquirer_unread:r.inquirer_unread,created_at:r.created_at}));w(d)}catch(s){console.error("Error loading conversations:",s),x("Failed to load conversations")}finally{h(!1)}},b=async s=>{try{const{data:a,error:d}=await m.from("messages").select("id, content, sender_id, created_at, is_read").eq("conversation_id",s).order("created_at",{ascending:!0});if(d)throw d;v(a||[])}catch(a){console.error("Error loading messages:",a),x("Failed to load messages")}},f=async()=>{if(!(!t||!n.trim()||o))try{p(!0);const{error:s}=await m.from("messages").insert({conversation_id:t.id,sender_id:l?.id,content:n.trim()});if(s)throw s;u(""),b(t.id),y(),T("Message sent")}catch(s){console.error("Error sending message:",s),x("Failed to send message")}finally{p(!1)}},S=(s,a)=>new Intl.NumberFormat("en-ZA",{style:"currency",currency:a}).format(s),j=s=>{const a=new Date(s),r=(new Date().getTime()-a.getTime())/(1e3*60*60);return r<24?a.toLocaleTimeString("en-ZA",{hour:"2-digit",minute:"2-digit"}):r<168?a.toLocaleDateString("en-ZA",{weekday:"short",hour:"2-digit",minute:"2-digit"}):a.toLocaleDateString("en-ZA",{month:"short",day:"numeric"})},C=s=>{switch(s){case"new":return"bg-blue-100 text-blue-800";case"active":return"bg-green-100 text-green-800";case"closed":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(M,{children:[e.jsx(q,{children:e.jsx("title",{children:"Messages | ArtFlow"})}),e.jsxs("div",{className:"py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Messages"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Communicate with artists about artworks"})]}),k?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):g.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(c,{name:"message-square",size:48,className:"mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No conversations yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Start a conversation by inquiring about an artwork"}),e.jsxs(A,{to:"/explore",className:"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(c,{name:"search",size:20,className:"mr-2"}),"Explore Artworks"]})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Conversations"})}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:g.map(s=>e.jsx("div",{onClick:()=>_(s),className:`p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${t?.id===s.id?"bg-blue-50":""}`,children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("img",{src:s.artwork.primary_image_url||"/placeholder-artwork.jpg",alt:s.artwork.title,className:"w-12 h-12 object-cover rounded-lg"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 truncate",children:s.artist.display_name}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${C(s.status)}`,children:s.status})]}),e.jsx("p",{className:"text-xs text-gray-600 mt-1 truncate",children:s.artwork.title}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 truncate",children:s.last_message_preview||"No messages yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:j(s.last_message_at)})]})]})},s.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:t?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 h-96 flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("img",{src:t.artwork.primary_image_url||"/placeholder-artwork.jpg",alt:t.artwork.title,className:"w-10 h-10 object-cover rounded-lg"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:t.artist.display_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.artwork.title," â€¢ ",S(t.artwork.price,t.artwork.currency)]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:N.map(s=>e.jsx("div",{className:`flex ${s.sender_id===l?.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs px-4 py-2 rounded-lg ${s.sender_id===l?.id?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"}`,children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.sender_id===l?.id?"text-blue-100":"text-gray-500"}`,children:j(s.created_at)})]})},s.id))}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:n,onChange:s=>u(s.target.value),onKeyPress:s=>s.key==="Enter"&&f(),placeholder:"Type your message...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",disabled:o}),e.jsx("button",{onClick:f,disabled:!n.trim()||o,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:o?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(c,{name:"send",size:20})})]})})]}):e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 h-96 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(c,{name:"message-square",size:48,className:"mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-600",children:"Choose a conversation from the list to start messaging"})]})})})]})]})]})};export{D as default};
